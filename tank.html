<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bắn Xe Tăng</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      background: #222;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    canvas {
      background: #444;
      width: 100vw;
      height: 100vh;
      display: block;
    }
    
    /* Joystick - góc trái */
    .joystick-container {
      position: fixed;
      bottom: 30px;
      left: 30px;
      display: none;
      z-index: 10;
      width: 150px;
      height: 150px;
      touch-action: none;
    }
    
    .joystick-base {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .joystick-handle {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.5);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
    }
    
    /* Nút bắn và bình nhiên liệu - góc phải */
    .shoot-controls {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: none;
      z-index: 10;
      flex-direction: row;
      gap: 20px;
      align-items: center;
    }
    
    .shoot-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 235, 59, 0.3);
      border: 3px solid #ffeb3b;
      color: #ffeb3b;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
      backdrop-filter: blur(5px);
    }
    
    .shoot-btn:hover {
      background: rgba(255, 235, 59, 0.5);
      transform: scale(1.1);
    }
    
    .shoot-btn:active {
      background: rgba(255, 235, 59, 0.7);
      transform: scale(0.9);
    }
    
    /* Nút bình nhiên liệu */
    .fuel-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(76, 175, 80, 0.3);
      border: 3px solid #4caf50;
      color: #4caf50;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
      backdrop-filter: blur(5px);
      margin-bottom: 10px;
    }
    
    .fuel-btn:hover {
      background: rgba(76, 175, 80, 0.5);
      transform: scale(1.1);
    }
    
    .fuel-btn:active {
      background: rgba(76, 175, 80, 0.7);
      transform: scale(0.9);
    }
    
    .fuel-btn.disabled {
      background: rgba(128, 128, 128, 0.3);
      border-color: #808080;
      color: #808080;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .fuel-btn.disabled:hover {
      transform: none;
      background: rgba(128, 128, 128, 0.3);
    }
    
    /* Nút tuyệt chiêu sóng điện */
    .electric-wave-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(138, 43, 226, 0.3);
      border: 3px solid #8a2be2;
      color: #8a2be2;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
      backdrop-filter: blur(5px);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    /* Nút tuyệt chiêu tên lửa */
    .missile-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 87, 34, 0.3);
      border: 3px solid #ff5722;
      color: #ff5722;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
      backdrop-filter: blur(5px);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    /* Nút kỹ năng bắn laser */
    .bullet-time-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.3);
      border: 3px solid #2196f3;
      color: #2196f3;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.1s;
      touch-action: manipulation;
      backdrop-filter: blur(5px);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .missile-btn:hover {
      background: rgba(255, 87, 34, 0.5);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 87, 34, 0.6);
    }
    
    .missile-btn:active {
      background: rgba(255, 87, 34, 0.7);
      transform: scale(0.9);
    }
    
    .missile-btn.disabled {
      background: rgba(128, 128, 128, 0.3);
      border-color: #808080;
      color: #808080;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .missile-btn.disabled:hover {
      transform: none;
      background: rgba(128, 128, 128, 0.3);
      box-shadow: none;
    }
    
    .electric-wave-btn:hover {
      background: rgba(138, 43, 226, 0.5);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
    }
    
    .electric-wave-btn:active {
      background: rgba(138, 43, 226, 0.7);
      transform: scale(0.9);
    }
    
    .electric-wave-btn.disabled {
      background: rgba(128, 128, 128, 0.3);
      border-color: #808080;
      color: #808080;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .electric-wave-btn.disabled:hover {
      transform: none;
      background: rgba(128, 128, 128, 0.3);
      box-shadow: none;
    }

    .bullet-time-btn:hover {
      background: rgba(33, 150, 243, 0.5);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
    }
    
    .bullet-time-btn:active {
      background: rgba(33, 150, 243, 0.7);
      transform: scale(0.9);
    }
    
    .bullet-time-btn.disabled {
      background: rgba(128, 128, 128, 0.3);
      border-color: #808080;
      color: #808080;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .bullet-time-btn.disabled:hover {
      transform: none;
      background: rgba(128, 128, 128, 0.3);
      box-shadow: none;
    }

    .bullet-time-btn.active {
      background: rgba(33, 150, 243, 0.8);
      box-shadow: 0 0 30px rgba(33, 150, 243, 1);
      animation: bulletTimePulse 1s infinite;
    }

    @keyframes bulletTimePulse {
      0%, 100% { box-shadow: 0 0 30px rgba(33, 150, 243, 1); }
      50% { box-shadow: 0 0 50px rgba(33, 150, 243, 0.8); }
    }
    
    /* Hiệu ứng cooldown cho nút tên lửa */
    .missile-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: conic-gradient(transparent 0deg, rgba(255, 87, 34, 0.8) 360deg);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .missile-btn.cooldown::after {
      opacity: 1;
      animation: cooldownSpin 0.1s linear;
    }

    /* Hiệu ứng cooldown cho nút sóng điện */
    .electric-wave-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: conic-gradient(transparent 0deg, rgba(138, 43, 226, 0.8) 360deg);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .electric-wave-btn.cooldown::after {
      opacity: 1;
      animation: cooldownSpin 0.1s linear;
    }

    /* Hiệu ứng cooldown cho nút bắn laser */
    .bullet-time-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: conic-gradient(transparent 0deg, rgba(33, 150, 243, 0.8) 360deg);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .bullet-time-btn.cooldown::after {
      opacity: 1;
      animation: cooldownSpin 0.1s linear;
    }
    
    @keyframes cooldownSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Responsive cho màn hình nhỏ */
    @media (max-width: 768px) {
      .joystick-container {
        width: 130px;
        height: 130px;
        bottom: 20px;
        left: 20px;
      }
      
      .joystick-handle {
        width: 50px;
        height: 50px;
      }
      
      .shoot-controls {
        bottom: 20px;
        right: 20px;
        gap: 15px;
      }
      
      .shoot-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
      
      .fuel-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
      
      .electric-wave-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
      
      .missile-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
      
      .bullet-time-btn {
        width: 70px;
        height: 70px;
        font-size: 28px;
      }
    }
    
    @media (max-width: 480px) {
      .joystick-container {
        width: 120px;
        height: 120px;
        bottom: 15px;
        left: 15px;
      }
      
      .joystick-handle {
        width: 45px;
        height: 45px;
      }
      
      .shoot-controls {
        bottom: 15px;
        right: 15px;
        gap: 12px;
      }
      
      .shoot-btn {
        width: 65px;
        height: 65px;
        font-size: 24px;
      }
      
      .fuel-btn {
        width: 65px;
        height: 65px;
        font-size: 24px;
      }
      
      .electric-wave-btn {
        width: 65px;
        height: 65px;
        font-size: 24px;
      }
      
      .missile-btn {
        width: 65px;
        height: 65px;
        font-size: 24px;
      }
      
      .bullet-time-btn {
        width: 65px;
        height: 65px;
        font-size: 24px;
      }
    }
    
    @media (max-width: 360px) {
      .joystick-container {
        width: 100px;
        height: 100px;
        bottom: 10px;
        left: 10px;
      }
      
      .joystick-handle {
        width: 40px;
        height: 40px;
      }
      
      .shoot-controls {
        bottom: 10px;
        right: 10px;
        gap: 10px;
      }
      
      .shoot-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
      
      .fuel-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
      
      .electric-wave-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
      
      .missile-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
      
      .bullet-time-btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <button id="startBtn" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em;padding:0.8em 2em;z-index:20;border:none;background:#4caf50;color:#fff;border-radius:15px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3);">🎮 Bắt đầu</button>
    <canvas id="gameCanvas" style="display:none;"></canvas>
    
    <!-- Joystick - góc trái -->
    <div class="joystick-container" id="joystickContainer">
      <div class="joystick-base" id="joystickBase">
        <div class="joystick-handle" id="joystickHandle"></div>
      </div>
    </div>
    
    <!-- Nút bắn và bình nhiên liệu - góc phải -->
    <div class="shoot-controls" id="shootControls">
      <button class="missile-btn" id="missileBtn">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
          <path d="M16 2 L20 8 L16 12 L12 8 Z"/>
          <rect x="14" y="8" width="4" height="16" rx="2"/>
          <path d="M12 20 L16 24 L20 20"/>
          <circle cx="16" cy="16" r="2" fill="#ffeb3b"/>
          <path d="M8 12 L12 14 L8 16 Z" fill="#ff9800"/>
          <path d="M24 12 L20 14 L24 16 Z" fill="#ff9800"/>
        </svg>
      </button>
      <button class="bullet-time-btn" id="bulletTimeBtn">🔴</button>
      <button class="electric-wave-btn" id="electricWaveBtn">⚡</button>
      <button class="fuel-btn" id="fuelBtn">⛽</button>
      <button class="shoot-btn" id="shootBtn"><img src="bullet.png" alt="Bullet" style="width: 30px; height: 30px;"></button>
    </div>
  </div>
  
  <audio id="bgm" src="my-love-don-t-let-love-fade.mp3" loop></audio>
  <script>

    // Đăng ký service worker cho PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').then(function(reg) {
          // Service worker registered
        }, function(err) {
          // Registration failed
        });
      });
    }

    const startBtn = document.getElementById('startBtn');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const bgm = document.getElementById('bgm');
    const joystickContainer = document.getElementById('joystickContainer');
    const joystickBase = document.getElementById('joystickBase');
    const joystickHandle = document.getElementById('joystickHandle');
    const shootControls = document.getElementById('shootControls');
    const fuelBtn = document.getElementById('fuelBtn');
    const electricWaveBtn = document.getElementById('electricWaveBtn');
    const missileBtn = document.getElementById('missileBtn');
    const bulletTimeBtn = document.getElementById('bulletTimeBtn');
    
    // Thiết lập canvas fullscreen
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    // Gọi resize khi tải trang và khi thay đổi kích thước
    window.addEventListener('resize', function() {
      if (gameStarted) {
        resizeCanvas();
      }
    });
    resizeCanvas();

    let gameStarted = false;
    
    // Hệ thống chiến thắng
    const victorySystem = {
      enemiesKilled: 0,
      targetKills: 30,
      gameWon: false
    };

    // Hệ thống tuyệt chiêu sóng điện
    const electricWaveSystem = {
      isReady: true,
      cooldownTime: 5000, // 5 giây cooldown
      currentCooldown: 0,
      waves: [], // Mảng chứa các sóng điện đang hoạt động
      waveRadius: 300, // Bán kính tối đa của sóng
      waveDamage: 5, // Sát thương của sóng điện
      waveSpeed: 8 // Tốc độ lan truyền sóng
    };

    // Hệ thống tuyệt chiêu tên lửa
    const missileSystem = {
      isReady: true,
      cooldownTime:  1000, // 3 giây cooldown
      currentCooldown: 0,
      missiles: [], // Mảng chứa các tên lửa đang bay
      missileSpeed: 6, // Tốc độ tên lửa
      missileDamage: 10, // Sát thương của tên lửa
      explosionRadius: 80, // Bán kính nổ
      homingRange: 200 // Phạm vi tự động tìm mục tiêu
    };

    // Hệ thống bản đồ vô tận
    const worldSystem = {
      offsetX: 0,
      offsetY: 0,
      tileSize: 40,
      terrain: [],
      decorations: []
    };

    // Sinh địa hình và trang trí
    function generateTerrain(startX, startY, width, height) {
      for (let x = startX; x < startX + width; x++) {
        for (let y = startY; y < startY + height; y++) {
          let key = `${x},${y}`;
          if (!worldSystem.terrain[key]) {
            // Sinh địa hình cơ bản
            let terrainType = 'grass';
            if (Math.random() < 0.1) terrainType = 'dirt';
            else if (Math.random() < 0.05) terrainType = 'stone';
            
            worldSystem.terrain[key] = {
              type: terrainType,
              x: x,
              y: y
            };
            
            // Sinh trang trí
            if (Math.random() < 0.08) {
              let decorationType = 'grass_tuft';
              if (Math.random() < 0.3) decorationType = 'small_rock';
              else if (Math.random() < 0.1) decorationType = 'tree';
              else if (Math.random() < 0.2) decorationType = 'bush';
              
              worldSystem.decorations.push({
                type: decorationType,
                x: x * worldSystem.tileSize + Math.random() * worldSystem.tileSize,
                y: y * worldSystem.tileSize + Math.random() * worldSystem.tileSize,
                size: 0.5 + Math.random() * 0.5
              });
            }
          }
        }
      }
    }

    // Vẽ địa hình
    function drawTerrain() {
      const startTileX = Math.floor(worldSystem.offsetX / worldSystem.tileSize) - 1;
      const startTileY = Math.floor(worldSystem.offsetY / worldSystem.tileSize) - 1;
      const endTileX = startTileX + Math.ceil(canvas.width / worldSystem.tileSize) + 2;
      const endTileY = startTileY + Math.ceil(canvas.height / worldSystem.tileSize) + 2;
      
      // Sinh thêm địa hình nếu cần
      generateTerrain(startTileX, startTileY, endTileX - startTileX, endTileY - startTileY);
      
      // Vẽ địa hình
      for (let x = startTileX; x < endTileX; x++) {
        for (let y = startTileY; y < endTileY; y++) {
          let key = `${x},${y}`;
          let terrain = worldSystem.terrain[key];
          if (terrain) {
            let screenX = x * worldSystem.tileSize - worldSystem.offsetX;
            let screenY = y * worldSystem.tileSize - worldSystem.offsetY;
            
            switch (terrain.type) {
              case 'grass':
                ctx.fillStyle = '#4a7c59';
                break;
              case 'dirt':
                ctx.fillStyle = '#8b4513';
                break;
              case 'stone':
                ctx.fillStyle = '#696969';
                break;
            }
            ctx.fillRect(screenX, screenY, worldSystem.tileSize, worldSystem.tileSize);
          }
        }
      }
    }

    // Vẽ trang trí
    function drawDecorations() {
      for (let decoration of worldSystem.decorations) {
        let screenX = decoration.x - worldSystem.offsetX;
        let screenY = decoration.y - worldSystem.offsetY;
        
        // Chỉ vẽ nếu trong phạm vi màn hình
        if (screenX > -50 && screenX < canvas.width + 50 && 
            screenY > -50 && screenY < canvas.height + 50) {
          
          ctx.save();
          let size = decoration.size * 20;
          
          switch (decoration.type) {
            case 'grass_tuft':
              ctx.fillStyle = '#228B22';
              ctx.beginPath();
              for (let i = 0; i < 5; i++) {
                let angle = (i / 5) * Math.PI * 2;
                let x = screenX + Math.cos(angle) * size * 0.3;
                let y = screenY + Math.sin(angle) * size * 0.2;
                ctx.lineTo(x, y);
              }
              ctx.fill();
              break;
              
            case 'small_rock':
              ctx.fillStyle = '#A0A0A0';
              ctx.beginPath();
              ctx.arc(screenX, screenY, size * 0.4, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = '#808080';
              ctx.beginPath();
              ctx.arc(screenX - size * 0.1, screenY - size * 0.1, size * 0.2, 0, Math.PI * 2);
              ctx.fill();
              break;
              
            case 'tree':
              // Thân cây
              ctx.fillStyle = '#8B4513';
              ctx.fillRect(screenX - size * 0.1, screenY - size * 0.3, size * 0.2, size * 0.6);
              // Lá cây
              ctx.fillStyle = '#228B22';
              ctx.beginPath();
              ctx.arc(screenX, screenY - size * 0.3, size * 0.4, 0, Math.PI * 2);
              ctx.fill();
              break;
              
            case 'bush':
              ctx.fillStyle = '#32CD32';
              ctx.beginPath();
              ctx.arc(screenX, screenY, size * 0.3, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = '#228B22';
              ctx.beginPath();
              ctx.arc(screenX - size * 0.1, screenY - size * 0.1, size * 0.2, 0, Math.PI * 2);
              ctx.fill();
              break;
          }
          ctx.restore();
        }
      }
    }

    const tank = {
        x: 400, // Vị trí trên màn hình
        y: 300, // Vị trí trên màn hình
        speed: 3,
        hp: 10,
        maxHp: 10,
        worldX: 400, // Vị trí thực trong thế giới
        worldY: 300,
        shootCooldown: 0,
        shootInterval: 10, // Thời gian chờ giữa các lần bắn (frames)
        angle: -Math.PI / 2, // Góc xoay của xe tăng (mặc định hướng lên)
        turretAngle: -Math.PI / 2, // Góc xoay của nòng pháo (có thể khác với thân xe)
        autoAim: true, // Bật tự động nhắm
        canShootWhileMoving: true, // Có thể bắn trong khi di chuyển
        autoShoot: false // Bắn tự động khi có mục tiêu
    };

    // Xe tăng nhỏ hỗ trợ
    const supportTank = {
        x: 350, // Vị trí trên màn hình
        y: 350, // Vị trí trên màn hình
        speed: 2.5, // Chậm hơn xe tăng chính một chút
        hp: 5,
        maxHp: 5,
        worldX: 350, // Vị trí thực trong thế giới
        worldY: 350,
        targetDistance: 80, // Khoảng cách mục tiêu từ xe tăng chính
        followAngle: Math.PI * 1.25, // Góc theo (bắt đầu ở phía sau bên trái)
        shootCooldown: 0,
        shootInterval: 45 // Bắn mỗi 45 frames (chậm hơn xe tăng chính)
    };

    let bullets = [];
    const bulletSpeed = 10;

    // Đạn của xe tăng hỗ trợ
    let supportBullets = [];
    const supportBulletSpeed = 8;

    // Đạn của xe tăng địch
    let enemyBullets = [];
    const enemyBulletSpeed = 5;


    function drawBullet(bullet, color = '#ffeb3b') {
      // Nếu là laser, vẽ tia laser thay vì viên đạn tròn
      if (bullet.isLaser) {
        drawLaser(bullet);
      } else {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawLaser(bullet) {
      ctx.save();
      
      // Tính toán điểm bắt đầu từ xe tăng
      const startX = tank.x + 30; // Giữa xe tăng
      const startY = tank.y + 10; // Phía trước xe tăng
      
      // Tính toán điểm cuối của tia laser (bắn thẳng lên)
      const laserLength = canvas.height + 100; // Độ dài tia laser đến hết màn hình
      const endX = startX;
      const endY = startY - laserLength;
      
      // Vẽ tia laser ngoài (màu xanh dương đậm với hiệu ứng phát sáng)
      ctx.strokeStyle = '#0080ff';
      ctx.lineWidth = 12;
      ctx.lineCap = 'round';
      ctx.shadowColor = '#0080ff';
      ctx.shadowBlur = 20;
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
      
      // Vẽ tia laser giữa (màu xanh dương sáng)
      ctx.strokeStyle = '#00bfff';
      ctx.lineWidth = 8;
      ctx.shadowBlur = 15;
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
      
      // Vẽ lõi laser (màu trắng)
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 4;
      ctx.shadowBlur = 8;
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
      
      // Vẽ hiệu ứng lấp lánh dọc theo tia laser
      for (let i = 0; i < 8; i++) {
        const sparkY = startY - (i * 80 + Math.random() * 60);
        const sparkX = startX + (Math.random() - 0.5) * 20;
        
        ctx.fillStyle = '#ffffff';
        ctx.shadowColor = '#00bfff';
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(sparkX, sparkY, 1 + Math.random() * 2, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Vẽ hiệu ứng năng lượng ở đầu súng
      ctx.fillStyle = '#ffffff';
      ctx.shadowColor = '#00bfff';
      ctx.shadowBlur = 15;
      ctx.beginPath();
      ctx.arc(startX, startY, 8, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.restore();
    }

    function drawExplosion(x, y) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(x + 30, y + 35, 25, 0, Math.PI * 2);
      ctx.fillStyle = 'orange';
      ctx.globalAlpha = 0.7;
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x + 30, y + 35, 12, 0, Math.PI * 2);
      ctx.fillStyle = 'yellow';
      ctx.globalAlpha = 0.9;
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    // Hàm sử dụng tuyệt chiêu sóng điện
    function useElectricWave() {
      if (!electricWaveSystem.isReady) return;
      
      // Tạo sóng điện mới
      electricWaveSystem.waves.push({
        x: tank.x + 30, // Tâm xe tăng
        y: tank.y + 35,
        worldX: tank.worldX + 30,
        worldY: tank.worldY + 35,
        radius: 0,
        maxRadius: electricWaveSystem.waveRadius,
        speed: electricWaveSystem.waveSpeed,
        damage: electricWaveSystem.waveDamage,
        opacity: 1,
        hitEnemies: [] // Danh sách kẻ địch đã bị trúng để tránh hit nhiều lần
      });
      
      // Bắt đầu cooldown
      electricWaveSystem.isReady = false;
      electricWaveSystem.currentCooldown = electricWaveSystem.cooldownTime;
      updateElectricWaveButton();
    }

    // Hàm vẽ sóng điện
    function drawElectricWave(wave) {
      ctx.save();
      
      // Vẽ vòng tròn sóng điện chính
      ctx.beginPath();
      ctx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2);
      ctx.strokeStyle = `rgba(138, 43, 226, ${wave.opacity})`;
      ctx.lineWidth = 4;
      ctx.stroke();
      
      // Vẽ hiệu ứng tia chớp
      ctx.strokeStyle = `rgba(255, 255, 255, ${wave.opacity * 0.8})`;
      ctx.lineWidth = 2;
      for (let i = 0; i < 8; i++) {
        let angle = (i / 8) * Math.PI * 2;
        let innerRadius = wave.radius * 0.7;
        let outerRadius = wave.radius * 1.1;
        
        ctx.beginPath();
        ctx.moveTo(
          wave.x + Math.cos(angle) * innerRadius,
          wave.y + Math.sin(angle) * innerRadius
        );
        ctx.lineTo(
          wave.x + Math.cos(angle) * outerRadius,
          wave.y + Math.sin(angle) * outerRadius
        );
        ctx.stroke();
      }
      
      // Vẽ vòng tròn bên trong với hiệu ứng phát sáng
      if (wave.radius > 20) {
        ctx.beginPath();
        ctx.arc(wave.x, wave.y, wave.radius * 0.3, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(138, 43, 226, ${wave.opacity * 0.3})`;
        ctx.fill();
      }
      
      ctx.restore();
    }

    // Hàm cập nhật nút sóng điện
    function updateElectricWaveButton() {
      if (electricWaveSystem.isReady) {
        electricWaveBtn.classList.remove('disabled');
        electricWaveBtn.classList.remove('cooldown');
        electricWaveBtn.style.opacity = '1';
      } else {
        electricWaveBtn.classList.add('disabled');
        electricWaveBtn.classList.add('cooldown');
        electricWaveBtn.style.opacity = '0.5';
      }
    }

    // Hàm sử dụng tuyệt chiêu tên lửa
    function useMissile() {
      if (!missileSystem.isReady) return;
      
      // Tạo tên lửa mới
      missileSystem.missiles.push({
        x: tank.x + 30, // Tâm xe tăng
        y: tank.y + 35,
        worldX: tank.worldX + 30,
        worldY: tank.worldY + 35,
        vx: 0, // Vận tốc ban đầu
        vy: -missileSystem.missileSpeed,
        target: null, // Mục tiêu hiện tại
        hasExploded: false,
        trailPoints: [] // Điểm để vẽ đuôi khói
      });
      
      // Bắt đầu cooldown
      missileSystem.isReady = false;
      missileSystem.currentCooldown = missileSystem.cooldownTime;
      updateMissileButton();
    }

    // Hàm vẽ tên lửa
    function drawMissile(missile) {
      ctx.save();
      
      // Vẽ đuôi khói
      if (missile.trailPoints.length > 1) {
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(missile.trailPoints[0].x, missile.trailPoints[0].y);
        for (let i = 1; i < missile.trailPoints.length; i++) {
          let alpha = i / missile.trailPoints.length * 0.6;
          ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
          ctx.lineTo(missile.trailPoints[i].x, missile.trailPoints[i].y);
        }
        ctx.stroke();
      }
      
      // Tính góc quay của tên lửa
      let angle = Math.atan2(missile.vy, missile.vx) + Math.PI / 2;
      
      ctx.translate(missile.x, missile.y);
      ctx.rotate(angle);
      
      // Vẽ thân tên lửa
      ctx.fillStyle = '#ff5722';
      ctx.fillRect(-4, -12, 8, 24);
      
      // Vẽ đầu tên lửa
      ctx.fillStyle = '#d32f2f';
      ctx.beginPath();
      ctx.moveTo(0, -12);
      ctx.lineTo(-4, -8);
      ctx.lineTo(4, -8);
      ctx.closePath();
      ctx.fill();
      
      // Vẽ cánh tên lửa
      ctx.fillStyle = '#ff9800';
      ctx.beginPath();
      ctx.moveTo(-6, 8);
      ctx.lineTo(-2, 4);
      ctx.lineTo(-2, 12);
      ctx.closePath();
      ctx.fill();
      
      ctx.beginPath();
      ctx.moveTo(6, 8);
      ctx.lineTo(2, 4);
      ctx.lineTo(2, 12);
      ctx.closePath();
      ctx.fill();
      
      // Vẽ lửa phía sau
      ctx.fillStyle = '#ffeb3b';
      ctx.beginPath();
      ctx.moveTo(-2, 12);
      ctx.lineTo(0, 18);
      ctx.lineTo(2, 12);
      ctx.closePath();
      ctx.fill();
      
      ctx.restore();
    }

    // Hàm vẽ vụ nổ tên lửa
    function drawMissileExplosion(x, y, radius, opacity) {
      ctx.save();
      
      // Vòng nổ chính
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 87, 34, ${opacity})`;
      ctx.fill();
      
      // Vòng nổ bên trong
      ctx.beginPath();
      ctx.arc(x, y, radius * 0.7, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 193, 7, ${opacity})`;
      ctx.fill();
      
      // Vòng nổ trung tâm
      ctx.beginPath();
      ctx.arc(x, y, radius * 0.4, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
      ctx.fill();
      
      ctx.restore();
    }

    // Hàm cập nhật nút tên lửa
    function updateMissileButton() {
      if (missileSystem.isReady) {
        missileBtn.classList.remove('disabled');
        missileBtn.classList.remove('cooldown');
        missileBtn.style.opacity = '1';
      } else {
        missileBtn.classList.add('disabled');
        missileBtn.classList.add('cooldown');
        missileBtn.style.opacity = '0.5';
      }
    }

// Hàm tìm kẻ thù gần nhất để nhắm
function findNearestEnemy(tankX, tankY) {
  let nearestEnemy = null;
  let minDistance = Infinity;
  
  for (let enemy of enemies) {
    if (enemy.hp <= 0) continue; // Bỏ qua kẻ thù đã chết
    
    let dx = enemy.x + 30 - (tankX + 30); // Tính từ tâm xe tăng
    let dy = enemy.y + 35 - (tankY + 35);
    let distance = Math.sqrt(dx * dx + dy * dy);
    
    if (distance < minDistance) {
      minDistance = distance;
      nearestEnemy = enemy;
    }
  }
  
  return nearestEnemy;
}

// Hàm tính góc nhắm đến mục tiêu
function calculateAimAngle(fromX, fromY, toX, toY) {
  let dx = toX - fromX;
  let dy = toY - fromY;
  return Math.atan2(dy, dx);
}

function drawTank(x, y, color = '#4caf50', turretColor = '#388e3c', reverse = false, hp, maxHp, angle = -Math.PI/2, turretAngle = null) {
  // reverse = false: xe tăng hướng lên, true: hướng xuống
  // angle: góc xoay của thân xe tăng
  // turretAngle: góc xoay của nòng pháo (nếu null thì dùng angle)
  ctx.save();
  
  // Nếu là xe tăng enemy thì vẽ theo cách cũ
  if (reverse) {
    ctx.translate(x + 30, y + 35);
    ctx.rotate(Math.PI);
    ctx.translate(-x - 30, -y - 35);
  }
  // Vẽ cột máu nếu có hp và maxHp (ưu tiên vẽ trước để không bị che)
  if (typeof hp === 'number' && typeof maxHp === 'number') {
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.strokeRect(x + 5, y - 15, 50, 7);
    // Thanh máu nền
    ctx.fillStyle = '#f44336';
    ctx.fillRect(x + 5, y - 15, 50, 7);
    // Đổi màu health bar theo phần trăm máu
    let percent = Math.max(0, Math.min(1, hp / maxHp));
    if (percent > 0.6) ctx.fillStyle = '#76ff03'; // xanh
    else if (percent > 0.3) ctx.fillStyle = '#ffeb3b'; // vàng
    else ctx.fillStyle = '#f44336'; // đỏ
    ctx.fillRect(x + 5, y - 15, 50 * percent, 7);
  }
  
  // Vẽ xe tăng với nòng pháo xoay được (chỉ cho xe tăng người chơi)
  if (!reverse && turretAngle !== null) {
    // Vẽ xe tăng với thân xe có thể xoay
    ctx.save();
    ctx.translate(x + 30, y + 35); // Di chuyển đến tâm xe tăng
    ctx.rotate(angle + Math.PI/2); // Xoay thân xe theo hướng di chuyển
    
    // Thân xe (vẽ từ tâm)
    ctx.fillStyle = color;
    ctx.fillRect(-30, -15, 60, 30);
    
    // Bánh xe (vẽ từ tâm)
    ctx.fillStyle = '#222';
    for (let i = 0; i < 3; i++) {
      ctx.beginPath();
      ctx.arc(-15 + i * 15, 15, 8, 0, Math.PI * 2);
      ctx.fill();
    }
    
    ctx.restore();
    
    // Tháp pháo (luôn ở tâm xe tăng, không xoay theo thân xe)
    ctx.fillStyle = turretColor;
    ctx.fillRect(x + 15, y + 20, 30, 30);
    
    // Vẽ nòng pháo xoay được
    ctx.save();
    ctx.translate(x + 30, y + 35); // Di chuyển đến tâm tháp pháo
    ctx.rotate(turretAngle); // Xoay theo góc nhắm
    
    // Vẽ nòng pháo
    ctx.fillStyle = '#222';
    ctx.fillRect(-3, -20, 6, 20); // Nòng pháo từ tâm tháp pháo
    
    ctx.restore();
  } else {
    // Vẽ xe tăng enemy theo cách cũ
    // Thân xe
    ctx.fillStyle = color;
    ctx.fillRect(x, y + 20, 60, 30);
    // Tháp pháo
    ctx.fillStyle = turretColor;
    ctx.fillRect(x + 15, y, 30, 30);
    // Nòng pháo
    ctx.fillStyle = '#222';
    ctx.fillRect(x + 27, y - 20, 6, 20);
    // Bánh xe
    ctx.fillStyle = '#222';
    for (let i = 0; i < 3; i++) {
      ctx.beginPath();
      ctx.arc(x + 15 + i * 15, y + 50, 8, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  
  ctx.restore();
}

// Hàm vẽ xe tăng nhỏ hỗ trợ (60% kích thước xe tăng chính)
function drawSupportTank(x, y, color = '#2196f3', turretColor = '#1976d2', hp, maxHp) {
  ctx.save();
  
  // Vẽ cột máu nếu có hp và maxHp
  if (typeof hp === 'number' && typeof maxHp === 'number') {
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1.5;
    ctx.strokeRect(x + 3, y - 12, 30, 5);
    // Thanh máu nền
    ctx.fillStyle = '#f44336';
    ctx.fillRect(x + 3, y - 12, 30, 5);
    // Đổi màu health bar theo phần trăm máu
    let percent = Math.max(0, Math.min(1, hp / maxHp));
    if (percent > 0.6) ctx.fillStyle = '#76ff03'; // xanh
    else if (percent > 0.3) ctx.fillStyle = '#ffeb3b'; // vàng
    else ctx.fillStyle = '#f44336'; // đỏ
    ctx.fillRect(x + 3, y - 12, 30 * percent, 5);
  }
  
  // Thân xe (60% kích thước)
  ctx.fillStyle = color;
  ctx.fillRect(x, y + 12, 36, 18);
  
  // Tháp pháo (60% kích thước)
  ctx.fillStyle = turretColor;
  ctx.fillRect(x + 9, y, 18, 18);
  
  // Nòng pháo (60% kích thước)
  ctx.fillStyle = '#222';
  ctx.fillRect(x + 16, y - 12, 4, 12);
  
  // Bánh xe (60% kích thước)
  ctx.fillStyle = '#222';
  for (let i = 0; i < 3; i++) {
    ctx.beginPath();
    ctx.arc(x + 9 + i * 9, y + 30, 5, 0, Math.PI * 2);
    ctx.fill();
  }
  
  ctx.restore();
}

// Enemy tanks
let enemies = [];
const enemySpeed = 2;
const enemySpawnInterval = 120; // frames - giảm tốc độ spawn 10 lần
let frameCount = 0;
let enemyIdCounter = 0; // Đếm ID duy nhất cho mỗi kẻ địch

function spawnEnemy() {
  // Random x position trong thế giới, spawn phía trên tank
  const x = Math.floor(Math.random() * (canvas.width - 60));
  const worldX = x + worldSystem.offsetX;
  const worldY = worldSystem.offsetY - 100; // Spawn phía trên vùng nhìn thấy
  
  // enemy sẽ có hướng di chuyển ngẫu nhiên ban đầu
  const dx = Math.random() < 0.5 ? enemySpeed : -enemySpeed;
  const dy = 1.5; // tốc độ xuống ổn định
  
  // Thêm hệ thống máu cho xe tăng địch và vị trí thế giới
  enemies.push({ 
    id: enemyIdCounter++, // ID duy nhất
    x: x, 
    y: -100, 
    dx: dx, 
    dy: dy, 
    hp: 3, 
    maxHp: 3,
    worldX: worldX,
    worldY: worldY
  });
}

    function clear() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Hàm cập nhật xe tăng hỗ trợ
    function updateSupportTank() {
      if (supportTank.hp <= 0) return; // Không cập nhật nếu xe tăng hỗ trợ đã chết
      
      // Tính vị trí mục tiêu xung quanh xe tăng chính
      let targetWorldX = tank.worldX + Math.cos(supportTank.followAngle) * supportTank.targetDistance;
      let targetWorldY = tank.worldY + Math.sin(supportTank.followAngle) * supportTank.targetDistance;
      
      // Tính khoảng cách đến vị trí mục tiêu
      let dx = targetWorldX - supportTank.worldX;
      let dy = targetWorldY - supportTank.worldY;
      let distance = Math.sqrt(dx * dx + dy * dy);
      
      // Di chuyển về phía vị trí mục tiêu nếu quá xa
      if (distance > 10) {
        let moveX = (dx / distance) * supportTank.speed;
        let moveY = (dy / distance) * supportTank.speed;
        
        supportTank.worldX += moveX;
        supportTank.worldY += moveY;
      }
      
      // Cập nhật vị trí trên màn hình
      supportTank.x = supportTank.worldX - worldSystem.offsetX;
      supportTank.y = supportTank.worldY - worldSystem.offsetY;
      
      // Xoay góc theo để tạo chuyển động tự nhiên
      supportTank.followAngle += 0.01;
      
      // Bắn đạn hỗ trợ
      supportTank.shootCooldown--;
      if (supportTank.shootCooldown <= 0 && enemies.length > 0) {
        // Tìm enemy gần nhất để bắn
        let closestEnemy = null;
        let closestDistance = Infinity;
        
        for (let enemy of enemies) {
          let dx = enemy.worldX - supportTank.worldX;
          let dy = enemy.worldY - supportTank.worldY;
          let distance = Math.sqrt(dx * dx + dy * dy);
          
          if (distance < closestDistance) {
            closestDistance = distance;
            closestEnemy = enemy;
          }
        }
        
        // Bắn về phía enemy gần nhất
        if (closestEnemy && closestDistance < 400) { // Chỉ bắn trong phạm vi 400px
          let dx = closestEnemy.worldX - supportTank.worldX;
          let dy = closestEnemy.worldY - supportTank.worldY;
          let distance = Math.sqrt(dx * dx + dy * dy);
          
          supportBullets.push({
            x: supportTank.x + 18, // Giữa xe tăng nhỏ
            y: supportTank.y,
            worldX: supportTank.worldX + 18,
            worldY: supportTank.worldY,
            dx: (dx / distance) * supportBulletSpeed,
            dy: (dy / distance) * supportBulletSpeed
          });
          
          supportTank.shootCooldown = supportTank.shootInterval;
        }
      }
    }

function update() {
  clear();
  
  // Vẽ bản đồ vô tận
  drawTerrain();
  drawDecorations();
  
  // Hiệu ứng nổ cho tank người chơi
  if (typeof window.tankExplosions === 'undefined') window.tankExplosions = [];

  // Kiểm tra chiến thắng
  if (victorySystem.gameWon) {
    showVictoryScreen();
    return;
  }
  
  // Nếu đã thua thì vẽ nổ và thông báo, không update nữa
  if (tank.hp <= 0) {
    // Vẽ hiệu ứng nổ nhiều frame
    if (window.tankExplosions.length === 0) {
      for (let i = 0; i < 20; i++) {
        window.tankExplosions.push({ x: tank.x, y: tank.y, time: i * 2 });
      }
    }
    for (let i = window.tankExplosions.length - 1; i >= 0; i--) {
      let ex = window.tankExplosions[i];
      if (ex.time <= 30) drawExplosion(ex.x, ex.y);
      ex.time++;
      if (ex.time > 30) window.tankExplosions.splice(i, 1);
    }
    ctx.save();
    ctx.font = 'bold 2.2em Arial';
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.shadowColor = '#000';
    ctx.shadowBlur = 8;
    ctx.fillText('Bạn đã thua trò chơi', canvas.width / 2, canvas.height / 2);
    ctx.restore();
    // Hiện nút chơi lại
    showReplayButton();
    return;
  }
  
  // Smooth tank movement với hệ thống thế giới vô tận
  let newWorldX = tank.worldX;
  let newWorldY = tank.worldY;
  let isMoving = false;
  let moveX = 0;
  let moveY = 0;
  
  if (keys['ArrowLeft']) {
    newWorldX -= tank.speed;
    moveX = -1;
    isMoving = true;
  }
  if (keys['ArrowRight']) {
    newWorldX += tank.speed;
    moveX = 1;
    isMoving = true;
  }
  if (keys['ArrowUp']) {
    newWorldY -= tank.speed;
    moveY = -1;
    isMoving = true;
  }
  if (keys['ArrowDown']) {
    newWorldY += tank.speed;
    moveY = 1;
    isMoving = true;
  }
  
  // Cập nhật góc xoay của thân xe tăng dựa trên hướng di chuyển
  if (isMoving) {
    tank.angle = Math.atan2(moveY, moveX);
    
    // Điều chỉnh tốc độ cho di chuyển chéo để tránh di chuyển nhanh hơn
    if (moveX !== 0 && moveY !== 0) {
      // Di chuyển chéo, giảm tốc độ xuống √2/2 ≈ 0.707
      let diagonalSpeed = tank.speed * 0.707;
      tank.worldX = tank.worldX - (newWorldX - tank.worldX) + moveX * diagonalSpeed;
      tank.worldY = tank.worldY - (newWorldY - tank.worldY) + moveY * diagonalSpeed;
      newWorldX = tank.worldX;
      newWorldY = tank.worldY;
    }
  }
  
  // Cập nhật vị trí thế giới
  tank.worldX = newWorldX;
  tank.worldY = newWorldY;
  
  // Giữ xe tăng ở trung tâm màn hình khi có thể
  let targetScreenX = canvas.width / 2 - 30;
  let targetScreenY = canvas.height / 2 - 25;
  
  // Cập nhật offset để xe tăng luôn ở giữa
  worldSystem.offsetX = tank.worldX - targetScreenX;
  worldSystem.offsetY = tank.worldY - targetScreenY;
  
  // Cập nhật vị trí xe tăng trên màn hình
  tank.x = tank.worldX - worldSystem.offsetX;
  tank.y = tank.worldY - worldSystem.offsetY;

  // Cập nhật xe tăng hỗ trợ
  updateSupportTank();

  // Cập nhật tự động nhắm mục tiêu
  if (tank.autoAim) {
    let nearestEnemy = findNearestEnemy(tank.x, tank.y);
    if (nearestEnemy) {
      // Tính góc nhắm đến kẻ thù gần nhất
      let targetX = nearestEnemy.x + 30; // Tâm kẻ thù
      let targetY = nearestEnemy.y + 35;
      let tankCenterX = tank.x + 30; // Tâm xe tăng
      let tankCenterY = tank.y + 35;
      
      tank.turretAngle = calculateAimAngle(tankCenterX, tankCenterY, targetX, targetY);
    } else {
      // Không có kẻ thù, nhắm thẳng lên
      tank.turretAngle = -Math.PI / 2;
    }
  }

  // Cập nhật cooldown bắn đạn
  if (tank.shootCooldown > 0) {
    tank.shootCooldown--;
  }

  // Bắn đạn (có thể bắn trong khi di chuyển)
  let shouldShoot = keys[' '] || (tank.autoShoot && findNearestEnemy(tank.x, tank.y) !== null);
  if (shouldShoot && tank.shootCooldown <= 0) {
    if (bulletTimeSystem.isActive) {
      // Khi laser hoạt động, chỉ đánh dấu laser đang bắn
      bulletTimeSystem.laserActive = true;
    } else {
      // Tính vị trí bắn từ đầu nòng pháo
      let barrelLength = 20;
      let barrelX = tank.x + 30 + Math.cos(tank.turretAngle) * barrelLength;
      let barrelY = tank.y + 35 + Math.sin(tank.turretAngle) * barrelLength;
      let worldBarrelX = tank.worldX + 30 + Math.cos(tank.turretAngle) * barrelLength;
      let worldBarrelY = tank.worldY + 35 + Math.sin(tank.turretAngle) * barrelLength;
      
      // Bắn đạn theo hướng nhắm
      bullets.push({ 
        x: barrelX, 
        y: barrelY, 
        worldX: worldBarrelX, 
        worldY: worldBarrelY,
        color: '#ffeb3b',
        isLaser: false,
        angle: tank.turretAngle // Bắn theo góc nhắm
      });
      
      tank.shootCooldown = tank.shootInterval;
      keys[' '] = false; // Chỉ bắn một viên mỗi lần nhấn
    }
  }
  
  // Nếu không nhấn space, tắt laser
  if (!keys[' ']) {
    bulletTimeSystem.laserActive = false;
  }

  // Cập nhật đạn của người chơi
  for (let i = bullets.length - 1; i >= 0; i--) {
    let bullet = bullets[i];
    
    // Di chuyển đạn theo góc bắn
    let speed = bulletSpeed;
    bullet.worldX += Math.cos(bullet.angle) * speed;
    bullet.worldY += Math.sin(bullet.angle) * speed;
    bullet.x = bullet.worldX - worldSystem.offsetX;
    bullet.y = bullet.worldY - worldSystem.offsetY;
    
    // Xóa đạn nếu ra khỏi màn hình hoặc đi quá xa
    if (bullet.x < -50 || bullet.x > canvas.width + 50 || 
        bullet.y < -50 || bullet.y > canvas.height + 50) {
      bullets.splice(i, 1);
    }
  }

  // Cập nhật đạn của xe tăng hỗ trợ
  for (let i = supportBullets.length - 1; i >= 0; i--) {
    let bullet = supportBullets[i];
    bullet.worldX += bullet.dx;
    bullet.worldY += bullet.dy;
    bullet.x = bullet.worldX - worldSystem.offsetX;
    bullet.y = bullet.worldY - worldSystem.offsetY;
    
    // Xóa đạn nếu ra khỏi màn hình
    if (bullet.x < -10 || bullet.x > canvas.width + 10 || 
        bullet.y < -10 || bullet.y > canvas.height + 10) {
      supportBullets.splice(i, 1);
    }
  }

  // Spawn enemies
  frameCount++;
  if (frameCount % enemySpawnInterval === 0) {
    spawnEnemy();
  }

  // Cập nhật enemies
  for (let i = enemies.length - 1; i >= 0; i--) {
    let enemy = enemies[i];
    
    // Cập nhật vị trí thế giới
    enemy.worldX += enemy.dx;
    enemy.worldY += enemy.dy;
    
    // Cập nhật vị trí trên màn hình
    enemy.x = enemy.worldX - worldSystem.offsetX;
    enemy.y = enemy.worldY - worldSystem.offsetY;
    
    // Đổi hướng khi chạm biên
    if (enemy.x <= 0 || enemy.x >= canvas.width - 60) {
      enemy.dx = -enemy.dx;
    }
    
    // Xóa enemy nếu ra khỏi màn hình dưới
    if (enemy.y > canvas.height + 100) {
      enemies.splice(i, 1);
      continue;
    }
    
    // Enemy bắn đạn ngẫu nhiên
    if (Math.random() < 0.01) {
      enemyBullets.push({ 
        x: enemy.x + 30, 
        y: enemy.y + 70,
        worldX: enemy.worldX + 30,
        worldY: enemy.worldY + 70
      });
    }
  }

  // Cập nhật đạn của enemy
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    let bullet = enemyBullets[i];
    bullet.worldY += enemyBulletSpeed;
    bullet.y = bullet.worldY - worldSystem.offsetY;
    
    // Xóa đạn nếu ra khỏi màn hình
    if (bullet.y > canvas.height + 10) {
      enemyBullets.splice(i, 1);
    }
  }

  // Kiểm tra va chạm đạn người chơi với enemies
  for (let i = bullets.length - 1; i >= 0; i--) {
    for (let j = enemies.length - 1; j >= 0; j--) {
      let bullet = bullets[i];
      let enemy = enemies[j];
      
      if (bullet && enemy && 
          bullet.x > enemy.x && bullet.x < enemy.x + 60 &&
          bullet.y > enemy.y && bullet.y < enemy.y + 70) {
        
        // Giảm máu enemy
        enemy.hp--;
        
        // Thêm hiệu ứng nổ
        if (typeof window.explosions === 'undefined') window.explosions = [];
        window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
        
        // Xóa đạn
        bullets.splice(i, 1);
        
        // Nếu máu về 0 thì thêm hiệu ứng nổ và xóa xe tăng
        if (enemy.hp <= 0) {
          window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
          enemies.splice(j, 1);
          
          // Tăng số quân địch đã tiêu diệt
          victorySystem.enemiesKilled++;
          
          // Kiểm tra điều kiện chiến thắng
          if (victorySystem.enemiesKilled >= victorySystem.targetKills) {
            victorySystem.gameWon = true;
          }
        }
        break;
      }
    }
  }

  // Kiểm tra va chạm laser với enemies
  if (bulletTimeSystem.isActive && bulletTimeSystem.laserActive) {
    const laserX = tank.x + 30;
    const laserWidth = 12; // Độ rộng tia laser
    
    for (let j = enemies.length - 1; j >= 0; j--) {
      let enemy = enemies[j];
      
      // Kiểm tra nếu enemy nằm trong đường laser (theo trục X) và phía trên xe tăng (theo trục Y)
      if (enemy.x < laserX + laserWidth/2 && enemy.x + 60 > laserX - laserWidth/2 && 
          enemy.y < tank.y) {
        
        // Giảm máu enemy liên tục (laser gây sát thương cao)
        enemy.hp -= 0.2; // Giảm từ từ để tạo hiệu ứng laser đốt cháy
        
        // Thêm hiệu ứng nổ
        if (typeof window.explosions === 'undefined') window.explosions = [];
        if (Math.random() < 0.3) { // Hiệu ứng nổ ngẫu nhiên
          window.explosions.push({ x: enemy.x + Math.random() * 60, y: enemy.y + Math.random() * 70, time: 0 });
        }
        
        // Nếu máu về 0 thì thêm hiệu ứng nổ lớn và xóa xe tăng
        if (enemy.hp <= 0) {
          window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
          enemies.splice(j, 1);
          
          // Tăng số quân địch đã tiêu diệt
          victorySystem.enemiesKilled++;
          
          // Kiểm tra điều kiện chiến thắng
          if (victorySystem.enemiesKilled >= victorySystem.targetKills) {
            victorySystem.gameWon = true;
          }
        }
      }
    }
  }

  // Kiểm tra va chạm đạn xe tăng hỗ trợ với enemies
  for (let i = supportBullets.length - 1; i >= 0; i--) {
    for (let j = enemies.length - 1; j >= 0; j--) {
      let bullet = supportBullets[i];
      let enemy = enemies[j];
      
      if (bullet && enemy && 
          bullet.x > enemy.x && bullet.x < enemy.x + 60 &&
          bullet.y > enemy.y && bullet.y < enemy.y + 70) {
        
        // Giảm máu enemy (đạn hỗ trợ gây ít sát thương hơn)
        enemy.hp--;
        
        // Thêm hiệu ứng nổ
        if (typeof window.explosions === 'undefined') window.explosions = [];
        window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
        
        // Xóa đạn
        supportBullets.splice(i, 1);
        
        // Nếu máu về 0 thì thêm hiệu ứng nổ và xóa xe tăng
        if (enemy.hp <= 0) {
          window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
          enemies.splice(j, 1);
          
          // Tăng số quân địch đã tiêu diệt
          victorySystem.enemiesKilled++;
          
          // Kiểm tra điều kiện chiến thắng
          if (victorySystem.enemiesKilled >= victorySystem.targetKills) {
            victorySystem.gameWon = true;
          }
        }
        break;
      }
    }
  }

  // Kiểm tra va chạm đạn enemy với tank người chơi
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    let bullet = enemyBullets[i];
    
    if (bullet.x > tank.x && bullet.x < tank.x + 60 &&
        bullet.y > tank.y && bullet.y < tank.y + 70) {
      
      // Giảm máu tank
      tank.hp--;
      
      // Thêm hiệu ứng nổ khi tank bị trúng
      if (typeof window.tankHitExplosions === 'undefined') window.tankHitExplosions = [];
      window.tankHitExplosions.push({ x: tank.x, y: tank.y, time: 0 });
      
      // Xóa đạn
      enemyBullets.splice(i, 1);
    }
  }

  // Kiểm tra va chạm đạn enemy với xe tăng hỗ trợ
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    let bullet = enemyBullets[i];
    
    if (supportTank.hp > 0 && 
        bullet.x > supportTank.x && bullet.x < supportTank.x + 36 &&
        bullet.y > supportTank.y && bullet.y < supportTank.y + 42) {
      
      // Giảm máu xe tăng hỗ trợ
      supportTank.hp--;
      
      // Thêm hiệu ứng nổ khi xe tăng hỗ trợ bị trúng
      if (typeof window.supportTankHitExplosions === 'undefined') window.supportTankHitExplosions = [];
      window.supportTankHitExplosions.push({ x: supportTank.x, y: supportTank.y, time: 0 });
      
      // Xóa đạn
      enemyBullets.splice(i, 1);
    }
  }

  // Vẽ hiệu ứng nổ khi tank bị trúng
  if (typeof window.tankHitExplosions !== 'undefined') {
    for (let i = window.tankHitExplosions.length - 1; i >= 0; i--) {
      let ex = window.tankHitExplosions[i];
      if (ex.time <= 15) drawExplosion(ex.x, ex.y);
      ex.time++;
      if (ex.time > 15) window.tankHitExplosions.splice(i, 1);
    }
  }

  // Vẽ hiệu ứng nổ khi xe tăng hỗ trợ bị trúng
  if (typeof window.supportTankHitExplosions !== 'undefined') {
    for (let i = window.supportTankHitExplosions.length - 1; i >= 0; i--) {
      let ex = window.supportTankHitExplosions[i];
      if (ex.time <= 15) drawExplosion(ex.x, ex.y);
      ex.time++;
      if (ex.time > 15) window.supportTankHitExplosions.splice(i, 1);
    }
  }

  // Vẽ tank người chơi (chỉ khi còn sống)
  if (tank.hp > 0) {
    drawTank(tank.x, tank.y, '#4caf50', '#388e3c', false, tank.hp, tank.maxHp, tank.angle, tank.turretAngle);
    
    // Vẽ đường chỉ báo hướng nhắm (chỉ khi tự động nhắm bật)
    if (tank.autoAim) {
      let nearestEnemy = findNearestEnemy(tank.x, tank.y);
      if (nearestEnemy) {
        ctx.save();
        ctx.strokeStyle = '#ff5722';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]); // Đường đứt nét
        ctx.beginPath();
        ctx.moveTo(tank.x + 30, tank.y + 35);
        ctx.lineTo(nearestEnemy.x + 30, nearestEnemy.y + 35);
        ctx.stroke();
        ctx.setLineDash([]); // Reset về đường liền nét
        ctx.restore();
      }
    }
  }

  // Vẽ xe tăng hỗ trợ (chỉ khi còn sống)
  if (supportTank.hp > 0) {
    drawSupportTank(supportTank.x, supportTank.y, '#2196f3', '#1976d2', supportTank.hp, supportTank.maxHp);
  }

  // Vẽ enemies
  for (let enemy of enemies) {
    drawTank(enemy.x, enemy.y, '#f44336', '#d32f2f', true, enemy.hp, enemy.maxHp);
  }

  // Vẽ tia laser nếu đang hoạt động
  if (bulletTimeSystem.isActive && bulletTimeSystem.laserActive) {
    drawLaser({ x: tank.x + 30, y: tank.y });
  }

  // Vẽ đạn của người chơi
  for (let bullet of bullets) {
    drawBullet(bullet, bullet.color || '#ffeb3b');
  }

  // Vẽ đạn của xe tăng hỗ trợ
  for (let bullet of supportBullets) {
    drawBullet(bullet, '#2196f3');
  }

  // Vẽ đạn của enemy
  for (let bullet of enemyBullets) {
    drawBullet(bullet, '#f44336');
  }

  // Vẽ hiệu ứng nổ
  if (typeof window.explosions !== 'undefined') {
    for (let i = window.explosions.length - 1; i >= 0; i--) {
      let ex = window.explosions[i];
      if (ex.time <= 30) drawExplosion(ex.x, ex.y);
      ex.time++;
      if (ex.time > 30) window.explosions.splice(i, 1);
    }
  }

  // Cập nhật và vẽ sóng điện
  for (let i = electricWaveSystem.waves.length - 1; i >= 0; i--) {
    let wave = electricWaveSystem.waves[i];
    
    // Cập nhật vị trí sóng trên màn hình
    wave.x = wave.worldX - worldSystem.offsetX;
    wave.y = wave.worldY - worldSystem.offsetY;
    
    // Tăng bán kính sóng
    wave.radius += wave.speed;
    
    // Giảm độ trong suốt theo thời gian
    wave.opacity = Math.max(0, 1 - (wave.radius / wave.maxRadius));
    
    // Kiểm tra va chạm với kẻ địch
    for (let j = enemies.length - 1; j >= 0; j--) {
      let enemy = enemies[j];
      
      // Kiểm tra xem kẻ địch đã bị trúng chưa
      if (wave.hitEnemies.includes(enemy.id)) continue;
      
      // Tính khoảng cách từ tâm sóng đến kẻ địch
      let dx = enemy.x + 30 - wave.x;
      let dy = enemy.y + 35 - wave.y;
      let distance = Math.sqrt(dx * dx + dy * dy);
      
      // Nếu kẻ địch nằm trong phạm vi sóng
      if (distance <= wave.radius && distance >= wave.radius - wave.speed * 2) {
        // Gây sát thương
        enemy.hp -= wave.damage;
        
        // Thêm hiệu ứng nổ điện
        if (typeof window.electricExplosions === 'undefined') window.electricExplosions = [];
        window.electricExplosions.push({ x: enemy.x, y: enemy.y, time: 0 });
        
        // Đánh dấu kẻ địch đã bị trúng
        wave.hitEnemies.push(enemy.id);
        
        // Nếu kẻ địch chết
        if (enemy.hp <= 0) {
          if (typeof window.explosions === 'undefined') window.explosions = [];
          window.explosions.push({ x: enemy.x, y: enemy.y, time: 0 });
          enemies.splice(j, 1);
          
          // Tăng số quân địch đã tiêu diệt
          victorySystem.enemiesKilled++;
          
          // Kiểm tra điều kiện chiến thắng
          if (victorySystem.enemiesKilled >= victorySystem.targetKills) {
            victorySystem.gameWon = true;
          }
        }
      }
    }
    
    // Vẽ sóng điện
    if (wave.x > -wave.maxRadius && wave.x < canvas.width + wave.maxRadius && 
        wave.y > -wave.maxRadius && wave.y < canvas.height + wave.maxRadius) {
      drawElectricWave(wave);
    }
    
    // Xóa sóng khi đã hết hiệu lực
    if (wave.radius >= wave.maxRadius) {
      electricWaveSystem.waves.splice(i, 1);
    }
  }

  // Vẽ hiệu ứng nổ điện
  if (typeof window.electricExplosions !== 'undefined') {
    for (let i = window.electricExplosions.length - 1; i >= 0; i--) {
      let ex = window.electricExplosions[i];
      if (ex.time <= 20) {
        // Vẽ hiệu ứng nổ điện
        ctx.save();
        ctx.beginPath();
        ctx.arc(ex.x + 30, ex.y + 35, 15 + ex.time, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(138, 43, 226, ${1 - ex.time / 20})`;
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Vẽ tia chớp nhỏ
        for (let j = 0; j < 6; j++) {
          let angle = (j / 6) * Math.PI * 2 + ex.time * 0.2;
          let radius = 10 + ex.time * 0.5;
          ctx.beginPath();
          ctx.moveTo(ex.x + 30, ex.y + 35);
          ctx.lineTo(
            ex.x + 30 + Math.cos(angle) * radius,
            ex.y + 35 + Math.sin(angle) * radius
          );
          ctx.strokeStyle = `rgba(255, 255, 255, ${1 - ex.time / 20})`;
          ctx.lineWidth = 2;
          ctx.stroke();
        }
        ctx.restore();
      }
      ex.time++;
      if (ex.time > 20) window.electricExplosions.splice(i, 1);
    }
  }

  // Cập nhật cooldown sóng điện
  if (!electricWaveSystem.isReady) {
    electricWaveSystem.currentCooldown -= 16.67; // Giả sử 60 FPS
    if (electricWaveSystem.currentCooldown <= 0) {
      electricWaveSystem.isReady = true;
      updateElectricWaveButton();
    }
  }
  
  // Cập nhật cooldown bình nhiên liệu
  if (!fuelSystem.isReady) {
    fuelSystem.currentCooldown -= 16.67; // Giả sử 60 FPS
    if (fuelSystem.currentCooldown <= 0) {
      fuelSystem.isReady = true;
      updateFuelButton();
    }
  }
  
  // Cập nhật Bắn laser
  if (bulletTimeSystem.isActive) {
    bulletTimeSystem.currentDuration -= 16.67; // Giả sử 60 FPS
    if (bulletTimeSystem.currentDuration <= 0) {
      // Kết thúc Bắn laser
      bulletTimeSystem.isActive = false;
      bulletTimeSystem.currentCooldown = bulletTimeSystem.cooldownTime;
      
      // Khôi phục thời gian bắn gốc (không cần làm gì vì logic bắn tự xử lý)
      
      updateBulletTimeButton();
      showBulletTimeMessage("🔴 Bắn laser kết thúc!");
    }
  } else if (!bulletTimeSystem.isReady) {
    bulletTimeSystem.currentCooldown -= 16.67; // Giả sử 60 FPS
    if (bulletTimeSystem.currentCooldown <= 0) {
      bulletTimeSystem.isReady = true;
      updateBulletTimeButton();
    }
  }

  // Cập nhật và vẽ tên lửa
  for (let i = missileSystem.missiles.length - 1; i >= 0; i--) {
    let missile = missileSystem.missiles[i];
    
    // Cập nhật vị trí tên lửa trên màn hình
    missile.x = missile.worldX - worldSystem.offsetX;
    missile.y = missile.worldY - worldSystem.offsetY;
    
    // Tìm mục tiêu gần nhất nếu chưa có
    if (!missile.target) {
      let closestDistance = missileSystem.homingRange;
      let closestEnemy = null;
      
      for (let enemy of enemies) {
        let dx = enemy.worldX + 30 - missile.worldX;
        let dy = enemy.worldY + 35 - missile.worldY;
        let distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestEnemy = enemy;
        }
      }
      
      missile.target = closestEnemy;
    }
    
    // Cập nhật hướng bay của tên lửa
    if (missile.target) {
      let dx = missile.target.worldX + 30 - missile.worldX;
      let dy = missile.target.worldY + 35 - missile.worldY;
      let distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance > 0) {
        // Tính hướng mới
        let targetVx = (dx / distance) * missileSystem.missileSpeed;
        let targetVy = (dy / distance) * missileSystem.missileSpeed;
        
        // Làm mượt chuyển hướng
        missile.vx += (targetVx - missile.vx) * 0.1;
        missile.vy += (targetVy - missile.vy) * 0.1;
      }
    }
    
    // Cập nhật vị trí thế giới
    missile.worldX += missile.vx;
    missile.worldY += missile.vy;
    
    // Thêm điểm vào đuôi khói
    missile.trailPoints.push({ x: missile.x, y: missile.y });
    if (missile.trailPoints.length > 10) {
      missile.trailPoints.shift();
    }
    
    // Kiểm tra va chạm với kẻ địch
    let hasHit = false;
    for (let j = enemies.length - 1; j >= 0; j--) {
      let enemy = enemies[j];
      let dx = enemy.x + 30 - missile.x;
      let dy = enemy.y + 35 - missile.y;
      let distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < 30) { // Va chạm trực tiếp
        hasHit = true;
        
        // Tạo vụ nổ
        if (typeof window.missileExplosions === 'undefined') window.missileExplosions = [];
        window.missileExplosions.push({
          x: missile.x,
          y: missile.y,
          radius: 0,
          maxRadius: missileSystem.explosionRadius,
          time: 0,
          maxTime: 30
        });
        
        // Gây sát thương cho tất cả kẻ địch trong phạm vi nổ
        for (let k = enemies.length - 1; k >= 0; k--) {
          let targetEnemy = enemies[k];
          let explosionDx = targetEnemy.x + 30 - missile.x;
          let explosionDy = targetEnemy.y + 35 - missile.y;
          let explosionDistance = Math.sqrt(explosionDx * explosionDx + explosionDy * explosionDy);
          
          if (explosionDistance <= missileSystem.explosionRadius) {
            targetEnemy.hp -= missileSystem.missileDamage;
            
            // Thêm hiệu ứng nổ cho từng kẻ địch bị trúng
            if (typeof window.explosions === 'undefined') window.explosions = [];
            window.explosions.push({ x: targetEnemy.x, y: targetEnemy.y, time: 0 });
            
            if (targetEnemy.hp <= 0) {
              enemies.splice(k, 1);
              victorySystem.enemiesKilled++;
              
              if (victorySystem.enemiesKilled >= victorySystem.targetKills) {
                victorySystem.gameWon = true;
              }
            }
          }
        }
        
        break;
      }
    }
    
    // Xóa tên lửa nếu ra khỏi màn hình hoặc đã nổ
    if (hasHit || missile.y < -50 || missile.y > canvas.height + 50 || 
        missile.x < -50 || missile.x > canvas.width + 50) {
      missileSystem.missiles.splice(i, 1);
      continue;
    }
    
    // Vẽ tên lửa
    if (missile.x > -50 && missile.x < canvas.width + 50 && 
        missile.y > -50 && missile.y < canvas.height + 50) {
      drawMissile(missile);
    }
  }

  // Vẽ hiệu ứng nổ tên lửa
  if (typeof window.missileExplosions !== 'undefined') {
    for (let i = window.missileExplosions.length - 1; i >= 0; i--) {
      let ex = window.missileExplosions[i];
      
      // Tăng bán kính nổ
      ex.radius = (ex.time / ex.maxTime) * ex.maxRadius;
      let opacity = 1 - (ex.time / ex.maxTime);
      
      if (ex.time <= ex.maxTime) {
        drawMissileExplosion(ex.x, ex.y, ex.radius, opacity);
      }
      
      ex.time++;
      if (ex.time > ex.maxTime) {
        window.missileExplosions.splice(i, 1);
      }
    }
  }

  // Cập nhật cooldown tên lửa
  if (!missileSystem.isReady) {
    missileSystem.currentCooldown -= 16.67; // Giả sử 60 FPS
    if (missileSystem.currentCooldown <= 0) {
      missileSystem.isReady = true;
      updateMissileButton();
    }
  }

  // Hiển thị thông tin game
  ctx.save();
  ctx.font = 'bold 1.2em Arial';
  ctx.fillStyle = '#fff';
  ctx.shadowColor = '#000';
  ctx.shadowBlur = 3;
  ctx.fillText(`HP: ${tank.hp}/${tank.maxHp}`, 20, 20);
  ctx.fillText(`Tiêu diệt: ${victorySystem.enemiesKilled}/${victorySystem.targetKills}`, 20, 40);
  
  // Hiển thị cooldown bình nhiên liệu
  if (!fuelSystem.isReady) {
    let cooldownSeconds = Math.ceil(fuelSystem.currentCooldown / 1000);
    ctx.fillStyle = '#4caf50';
    ctx.fillText(`⛽ Nhiên liệu: ${cooldownSeconds}s`, 20, 60);
  } else {
    ctx.fillStyle = '#4caf50';
    ctx.fillText(`⛽ Nhiên liệu: Sẵn sàng`, 20, 60);
  }
  
  // Hiển thị thông báo fuel
  if (fuelMessage.time > 0) {
    ctx.fillStyle = '#4caf50';
    ctx.fillText(fuelMessage.text, 20, 80);
    fuelMessage.time--;
  }
  
  // Hiển thị thông báo bắn laser
  if (bulletTimeMessage.time > 0) {
    ctx.fillStyle = '#2196f3';
    ctx.fillText(bulletTimeMessage.text, 20, 160);
    bulletTimeMessage.time--;
  }
  
  // Hiển thị thông báo chung
  if (generalMessage.time > 0) {
    ctx.fillStyle = '#ffeb3b';
    ctx.fillText(generalMessage.text, 20, 180);
    generalMessage.time--;
  }
  
  // Hiển thị trạng thái tự động nhắm và bắn tự động
  ctx.fillStyle = tank.autoAim ? '#4caf50' : '#f44336';
  ctx.fillText(`🎯 Tự động nhắm: ${tank.autoAim ? 'BẬT' : 'TẮT'} (A)`, 20, 200);
  
  ctx.fillStyle = tank.autoShoot ? '#4caf50' : '#f44336';
  ctx.fillText(`🔫 Bắn tự động: ${tank.autoShoot ? 'BẬT' : 'TẮT'} (Z)`, 20, 220);
  
  // Hiển thị cooldown sóng điện
  if (!electricWaveSystem.isReady) {
    let cooldownSeconds = Math.ceil(electricWaveSystem.currentCooldown / 1000);
    ctx.fillStyle = '#8a2be2';
    ctx.fillText(`⚡ Sóng điện: ${cooldownSeconds}s`, 20, 100);
  } else {
    ctx.fillStyle = '#8a2be2';
    ctx.fillText(`⚡ Sóng điện: Sẵn sàng`, 20, 100);
  }
  
  // Hiển thị cooldown tên lửa
  if (!missileSystem.isReady) {
    let cooldownSeconds = Math.ceil(missileSystem.currentCooldown / 1000);
    ctx.fillStyle = '#ff5722';
    ctx.fillText(`🚀 Tên lửa: ${cooldownSeconds}s`, 20, 120);
  } else {
    ctx.fillStyle = '#ff5722';
    ctx.fillText(`🚀 Tên lửa: Sẵn sàng`, 20, 120);
  }
  
  // Hiển thị trạng thái Bắn laser
  if (bulletTimeSystem.isActive) {
    let durationSeconds = Math.ceil(bulletTimeSystem.currentDuration / 1000);
    ctx.fillStyle = '#2196f3';
    ctx.fillText(`🔴 Bắn laser: ${durationSeconds}s`, 20, 140);
  } else if (!bulletTimeSystem.isReady) {
    let cooldownSeconds = Math.ceil(bulletTimeSystem.currentCooldown / 1000);
    ctx.fillStyle = '#2196f3';
    ctx.fillText(`🔴 Bắn laser: ${cooldownSeconds}s`, 20, 140);
  } else {
    ctx.fillStyle = '#2196f3';
    ctx.fillText(`🔴 Bắn laser: Sẵn sàng`, 20, 140);
  }
  ctx.restore();

  // Cập nhật trạng thái nút bình nhiên liệu
  updateFuelButton();
  
  // Hệ thống bình nhiên liệu - thời gian chờ 3 giây
}

// Thêm nút chơi lại
function showReplayButton() {
  let btn = document.getElementById('replayBtn');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'replayBtn';
    btn.innerText = 'Chơi lại';
    btn.style.position = 'fixed';
    btn.style.top = 'calc(50% + 60px)';
    btn.style.left = '50%';
    btn.style.transform = 'translate(-50%,0)';
    btn.style.fontSize = '2em';
    btn.style.padding = '0.5em 2em';
    btn.style.zIndex = '100';
    btn.style.background = '#2196f3';
    btn.style.color = '#fff';
    btn.style.border = 'none';
    btn.style.borderRadius = '15px';
    btn.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
    btn.style.cursor = 'pointer';
    document.body.appendChild(btn);
    btn.addEventListener('click', function() {
      // Reset trạng thái game
      resetGame();
      btn.remove();
    });
  }
  btn.style.display = 'block';
}

// Hiển thị màn hình chiến thắng
function showVictoryScreen() {
  // Hiệu ứng pháo hoa (có thể thêm sau)
  ctx.save();
  ctx.font = 'bold 3em Arial';
  ctx.fillStyle = '#FFD700';
  ctx.textAlign = 'center';
  ctx.shadowColor = '#000';
  ctx.shadowBlur = 10;
  ctx.fillText('🎉 CHIẾN THẮNG! 🎉', canvas.width / 2, canvas.height / 2 - 50);
  
  ctx.font = 'bold 1.5em Arial';
  ctx.fillStyle = '#fff';
  ctx.fillText(`Đã tiêu diệt ${victorySystem.targetKills} quân địch!`, canvas.width / 2, canvas.height / 2 + 20);
  ctx.restore();
  
  // Hiện nút chơi lại
  showReplayButton();
}

function resetGame() {
  // Reset các biến game
  tank.hp = tank.maxHp;
  tank.x = canvas.width/2 - 30;
  tank.y = canvas.height - 120;
  if (typeof tank.worldX !== 'undefined') tank.worldX = 0;
  if (typeof tank.worldY !== 'undefined') tank.worldY = 0;
  bullets = [];
  enemyBullets = [];
  enemies = [];
  window.explosions = [];
  window.tankExplosions = [];
  window.tankHitExplosions = [];
  window.electricExplosions = [];
  window.missileExplosions = [];
  frameCount = 0;
  enemyIdCounter = 0;
  gameStarted = true;
  
  // Reset hệ thống bình nhiên liệu
  fuelSystem.isReady = true;
  fuelSystem.currentCooldown = 0;
  updateFuelButton();
  
  // Reset hệ thống sóng điện
  electricWaveSystem.isReady = true;
  electricWaveSystem.currentCooldown = 0;
  electricWaveSystem.waves = [];
  updateElectricWaveButton();
  
  // Reset hệ thống tên lửa - luôn sẵn sàng
  missileSystem.isReady = true;
  missileSystem.currentCooldown = 0;
  missileSystem.missiles = [];
  updateMissileButton();
  
  // Reset hệ thống Bắn laser
  bulletTimeSystem.isActive = false;
  bulletTimeSystem.isReady = true;
  bulletTimeSystem.currentDuration = 0;
  bulletTimeSystem.currentCooldown = 0;
  updateBulletTimeButton();
  
  // Reset hệ thống chiến thắng
  victorySystem.enemiesKilled = 0;
  victorySystem.gameWon = false;
  // Ẩn nút replay nếu còn
  let btn = document.getElementById('replayBtn');
  if (btn) btn.style.display = 'none';
  // Bật lại controls nếu có
  if (joystickContainer) joystickContainer.style.display = 'block';
  if (shootControls) shootControls.style.display = 'block';
  // Bật lại nhạc
  bgm.currentTime = 0;
  bgm.play();
  // Chạy lại game loop
  requestAnimationFrame(gameLoop);
}

    // Xử lý phím mũi tên và bắn đạn
    // Smooth movement and shooting with key state
    const keys = {};
    document.addEventListener('keydown', function(e) {
      keys[e.key] = true;
      
      // Phím F để sử dụng bình nhiên liệu
      if (e.key === 'f' || e.key === 'F') {
        useFuel();
      }
      
      // Phím E để sử dụng sóng điện
      if (e.key === 'e' || e.key === 'E') {
        useElectricWave();
      }
      
      // Phím số 1 để sử dụng tên lửa
      if (e.key === '1') {
        useMissile();
      }
      
      // Phím T để sử dụng Đạn thời gian
      if (e.key === 't' || e.key === 'T') {
        useBulletTime();
      }
      
      // Phím A để bật/tắt tự động nhắm
      if (e.key === 'a' || e.key === 'A') {
        tank.autoAim = !tank.autoAim;
        showMessage(tank.autoAim ? "🎯 Tự động nhắm: BẬT" : "🎯 Tự động nhắm: TẮT");
      }
      
      // Phím Z để bật/tắt bắn tự động
      if (e.key === 'z' || e.key === 'Z') {
        tank.autoShoot = !tank.autoShoot;
        showMessage(tank.autoShoot ? "🔫 Bắn tự động: BẬT" : "🔫 Bắn tự động: TẮT");
      }
    });
    document.addEventListener('keyup', function(e) {
      keys[e.key] = false;
    });

    // Hệ thống bình nhiên liệu
    const fuelSystem = {
      isReady: true,
      cooldownTime: 3000, // 3 giây thời gian chờ
      currentCooldown: 0
    };

    function useFuel() {
      if (fuelSystem.isReady) {
        let fuelUsed = false;
        
        // Ưu tiên bơm cho xe tăng chính trước
        if (tank.hp < tank.maxHp) {
          tank.hp = Math.min(tank.hp + 2, tank.maxHp); // Hồi 2 máu cho xe tăng chính
          // Hiển thị thông báo ngắn
          showFuelMessage("Bơm máu xe tăng chính +2 ❤️");
          fuelUsed = true;
        }
        // Nếu xe tăng chính đã đầy máu, bơm cho xe tăng nhỏ
        else if (supportTank.hp > 0 && supportTank.hp < supportTank.maxHp) {
          supportTank.hp = Math.min(supportTank.hp + 2, supportTank.maxHp); // Hồi 2 máu cho xe tăng nhỏ
          // Hiển thị thông báo ngắn
          showFuelMessage("Bơm máu xe tăng nhỏ +2 💙");
          fuelUsed = true;
        }
        
        // Nếu đã sử dụng fuel, bắt đầu thời gian chờ
        if (fuelUsed) {
          fuelSystem.isReady = false;
          fuelSystem.currentCooldown = fuelSystem.cooldownTime;
        }
        
        updateFuelButton();
      }
    }

    // Hệ thống thông báo fuel
    let fuelMessage = { text: '', time: 0 };
    
    function showFuelMessage(text) {
      fuelMessage.text = text;
      fuelMessage.time = 60; // Hiển thị trong 60 frames (1 giây)
    }
    
    function updateFuelButton() {
      // Kiểm tra xem có thể bơm cho xe tăng chính hoặc xe tăng nhỏ không
      const canRefuelMainTank = tank.hp < tank.maxHp;
      const canRefuelSupportTank = supportTank.hp > 0 && supportTank.hp < supportTank.maxHp;
      
      if (fuelSystem.isReady && (canRefuelMainTank || canRefuelSupportTank)) {
        fuelBtn.classList.remove('disabled');
        fuelBtn.style.opacity = '1';
      } else {
        fuelBtn.classList.add('disabled');
        fuelBtn.style.opacity = '0.5';
      }
    }

    // Hệ thống Bắn laser
    const bulletTimeSystem = {
      isActive: false,
      isReady: true,
      duration: 30000, // 30 giây
      cooldownTime: 10000, // 10 giây thời gian chờ
      currentDuration: 0,
      currentCooldown: 0,
      originalShootCooldown: 10, // Lưu lại thời gian bắn gốc
      laserActive: false // Trạng thái tia laser có đang hoạt động không
    };

    function useBulletTime() {
      if (bulletTimeSystem.isReady && !bulletTimeSystem.isActive) {
        bulletTimeSystem.isActive = true;
        bulletTimeSystem.isReady = false;
        bulletTimeSystem.currentDuration = bulletTimeSystem.duration;
        
        // Lưu lại thời gian bắn gốc và đặt thành 0 (bắn liên tục)
        bulletTimeSystem.originalShootCooldown = tank.shootInterval;
        // Không cần thay đổi tank.shootCooldown ở đây vì logic bắn đã xử lý
        
        // Cập nhật giao diện nút
        updateBulletTimeButton();
        
        // Hiển thị thông báo
        showBulletTimeMessage("🔴 Bắn laser kích hoạt!");
      }
    }

    function updateBulletTimeButton() {
      if (bulletTimeSystem.isActive) {
        bulletTimeBtn.classList.add('active');
        bulletTimeBtn.classList.remove('disabled');
      } else if (bulletTimeSystem.isReady) {
        bulletTimeBtn.classList.remove('disabled', 'active');
        bulletTimeBtn.style.opacity = '1';
      } else {
        bulletTimeBtn.classList.add('disabled');
        bulletTimeBtn.classList.remove('active');
        bulletTimeBtn.style.opacity = '0.5';
      }
    }

    // Hệ thống thông báo bắn laser
    let bulletTimeMessage = { text: '', time: 0 };
    
    function showBulletTimeMessage(text) {
      bulletTimeMessage.text = text;
      bulletTimeMessage.time = 60; // Hiển thị trong 60 frames (1 giây)
    }

    // Hệ thống thông báo chung
    let generalMessage = { text: '', time: 0 };
    
    function showMessage(text) {
      generalMessage.text = text;
      generalMessage.time = 120; // Hiển thị trong 120 frames (2 giây)
    }

    function initWorldSystem() {
      // Đặt offset ban đầu để xe tăng ở giữa màn hình
      worldSystem.offsetX = tank.worldX - (canvas.width / 2 - 30);
      worldSystem.offsetY = tank.worldY - (canvas.height / 2 - 25);
      
      // Cập nhật vị trí xe tăng trên màn hình
      tank.x = tank.worldX - worldSystem.offsetX;
      tank.y = tank.worldY - worldSystem.offsetY;
    }

    // Joystick và nút bắn
    const joystick = {
      active: false,
      baseX: 0,
      baseY: 0,
      handleX: 0,
      handleY: 0,
      limitRadius: 0,
      dx: 0,
      dy: 0
    };
    
    const shootButton = document.getElementById('shootBtn');
    
    // Xử lý sự kiện điều khiển
    function setupControls() {
      // Khởi tạo joystick
      const baseRect = joystickBase.getBoundingClientRect();
      joystick.baseX = baseRect.left + baseRect.width / 2;
      joystick.baseY = baseRect.top + baseRect.height / 2;
      joystick.limitRadius = baseRect.width / 2 - joystickHandle.offsetWidth / 2;
      
      // Đặt handle vào giữa
      joystick.handleX = joystick.baseX;
      joystick.handleY = joystick.baseY;
      updateJoystickPosition();
      
      // Mouse events for joystick
      joystickHandle.addEventListener('mousedown', startJoystick);
      document.addEventListener('mousemove', moveJoystick);
      document.addEventListener('mouseup', endJoystick);
      
      // Touch events for joystick
      joystickHandle.addEventListener('touchstart', startJoystick);
      document.addEventListener('touchmove', moveJoystick);
      document.addEventListener('touchend', endJoystick);
      document.addEventListener('touchcancel', endJoystick);
      
      // Nút bắn
      shootButton.addEventListener('mousedown', () => keys[' '] = true);
      shootButton.addEventListener('mouseup', () => keys[' '] = false);
      shootButton.addEventListener('mouseleave', () => keys[' '] = false);
      
      // Touch events cho nút bắn - hỗ trợ giữ để bắn liên tục
      shootButton.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        keys[' '] = true; 
      });
      shootButton.addEventListener('touchend', (e) => { 
        e.preventDefault(); 
        keys[' '] = false; 
      });
      shootButton.addEventListener('touchcancel', (e) => { 
        e.preventDefault(); 
        keys[' '] = false; 
      });
      
      // Nút bình nhiên liệu
      fuelBtn.addEventListener('click', useFuel);
      fuelBtn.addEventListener('touchstart', (e) => { e.preventDefault(); useFuel(); });
      
      // Nút sóng điện
      electricWaveBtn.addEventListener('click', useElectricWave);
      electricWaveBtn.addEventListener('touchstart', (e) => { e.preventDefault(); useElectricWave(); });
      
      // Nút tên lửa
      missileBtn.addEventListener('click', useMissile);
      missileBtn.addEventListener('touchstart', (e) => { e.preventDefault(); useMissile(); });
      
      // Nút Bắn laser
      bulletTimeBtn.addEventListener('click', useBulletTime);
      bulletTimeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); useBulletTime(); });
    }
    
    function startJoystick(e) {
      e.preventDefault();
      joystick.active = true;
      
      // Recalculate base position in case of screen resize
      const baseRect = joystickBase.getBoundingClientRect();
      joystick.baseX = baseRect.left + baseRect.width / 2;
      joystick.baseY = baseRect.top + baseRect.height / 2;
      joystick.limitRadius = baseRect.width / 2 - joystickHandle.offsetWidth / 2;
    }
    
    function moveJoystick(e) {
      if (!joystick.active) return;
      e.preventDefault();
      
      let clientX, clientY;
      
      if (e.type === 'touchmove') {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      
      // Calculate distance from center
      let dx = clientX - joystick.baseX;
      let dy = clientY - joystick.baseY;
      let distance = Math.sqrt(dx * dx + dy * dy);
      
      // Limit to circle
      if (distance > joystick.limitRadius) {
        dx = dx * joystick.limitRadius / distance;
        dy = dy * joystick.limitRadius / distance;
      }
      
      // Update handle position
      joystick.handleX = joystick.baseX + dx;
      joystick.handleY = joystick.baseY + dy;
      
      // Update joystick values for game controls
      joystick.dx = dx / joystick.limitRadius; // -1 to 1
      joystick.dy = dy / joystick.limitRadius; // -1 to 1
      
      // Update visual position
      updateJoystickPosition();
      
      // Update key states based on joystick position
      updateKeyStates();
    }
    
    function endJoystick(e) {
      if (!joystick.active) return;
      e.preventDefault();
      joystick.active = false;
      
      // Reset joystick to center
      joystick.handleX = joystick.baseX;
      joystick.handleY = joystick.baseY;
      joystick.dx = 0;
      joystick.dy = 0;
      
      // Update visual position
      updateJoystickPosition();
      
      // Reset all direction keys
      keys['ArrowUp'] = false;
      keys['ArrowDown'] = false;
      keys['ArrowLeft'] = false;
      keys['ArrowRight'] = false;
    }
    
    function updateJoystickPosition() {
      joystickHandle.style.transform = `translate(${joystick.handleX - joystick.baseX}px, ${joystick.handleY - joystick.baseY}px)`;
    }
    
    function updateKeyStates() {
      // Convert joystick position to key presses
      const deadzone = 0.3; // Ignore small movements
      
      keys['ArrowUp'] = joystick.dy < -deadzone;
      keys['ArrowDown'] = joystick.dy > deadzone;
      keys['ArrowLeft'] = joystick.dx < -deadzone;
      keys['ArrowRight'] = joystick.dx > deadzone;
    }

    function gameLoop() {
      if (gameStarted) {
        update();
        requestAnimationFrame(gameLoop);
      }
    }

startBtn.addEventListener('click', function() {
      startBtn.style.display = 'none';
      canvas.style.display = 'block';
      joystickContainer.style.display = 'block';
      shootControls.style.display = 'block';
      gameStarted = true;
      
      // Đảm bảo canvas fullscreen
      resizeCanvas();
      
      // Khởi tạo hệ thống thế giới
      initWorldSystem();
      
      // Thiết lập điều khiển joystick
      setupControls();
      
      // Khởi tạo trạng thái nút bình nhiên liệu
      updateFuelButton();
      
      // Khởi tạo trạng thái nút sóng điện
      updateElectricWaveButton();
      
      // Khởi tạo trạng thái nút tên lửa
      updateMissileButton();
      
      // Khởi tạo trạng thái nút Bắn laser
      updateBulletTimeButton();
      
      bgm.currentTime = 0;
      // Try to play audio, fallback if blocked
      bgm.play().then(() => {
        // success
      }).catch(() => {
        // If failed, show a message and try again on next user gesture
        alert('Click anywhere to enable game music!');
        document.body.addEventListener('click', function tryPlay() {
          bgm.play();
          document.body.removeEventListener('click', tryPlay);
        });
      });
      gameLoop();
    });
  </script>
</body>
</html>
